name: Checkov Security Scan

on:
  workflow_call:
    inputs:
      directory:
        required: true
        type: string
        description: 'Directory to scan (relative to repository root)'
      continue_on_error:
        required: true
        type: string
        default: 'true'
        description: 'Whether to continue on error (true/false)'
      var_file:
        required: false
        type: string
        description: 'Path to Terraform variable file'
      download_external_modules:
        required: false
        type: string
        default: 'false'
        description: 'Whether to download external modules (true/false)'

jobs:
  scan:
    permissions:
      contents: read
      security-events: write
      actions: read

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Checkov GitHub Action
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          output_format: cli,sarif
          output_file_path: console,results.sarif
          soft_fail: ${{ inputs.continue_on_error == 'true' }}
          directory: ${{ inputs.directory }}
          var_file: ${{ inputs.var_file }}
          download_external_modules: ${{ inputs.download_external_modules }}
          framework: terraform

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: success() || failure()
        with:
          sarif_file: results.sarif
          category: checkov
