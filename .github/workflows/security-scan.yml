name: Terraform Security Scan

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  security_scan:
    name: Scan Terraform Code with Trivy & Checkov
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Install Terraform
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      # Terraform Init & Validate
      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      # Install Trivy
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh

      # Run Trivy Security Scan
      - name: Run Trivy on Terraform Code
        run: trivy config --severity HIGH,CRITICAL .

      # Install Checkov
      - name: Install Checkov
        run: pip install checkov

      # Run Checkov Security Scan
      - name: Run Checkov on Terraform Code
        run: checkov -d . --soft-fail
